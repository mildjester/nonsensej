<!DOCTYPE html>
<html lang="ja-JP">
    <head>
		
		
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>javascriptでライブラリ無しでオートコンプリート &middot; Nonsense J</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Nonsense J" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Nonsense J</h2>
				</a>
				<ul>
    
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<h1 class="post-title">javascriptでライブラリ無しでオートコンプリート</h1>
		<div class="post-info">
				<time datetime="2020-10-25 00:00:00 &#43;0000 UTC">October 25, 2020</time>
			
				<div class="tags_list">
					 <div class="tags_item"><a href="/tags/javascript/">javascript</a></div>
				</div>
			
		</div>
		<p>javascriptを使ってイチからオートコンプリートを実装しました。</p>
<p>オートコンプリートは何もなければライブラリを使って実装するのが早いですが、
イチから自分で実装する機会があったのでメモを残します。</p>
<h2 id="要件">要件</h2>
<ul>
<li>PC(Chrome, IE, Safari), Android(Chrome), iPhone(safari)に対応する。</li>
<li>入力したキーワードを含む都道府県を選択肢として表示する。</li>
<li>選択肢をクリックしたら選択したこととする。</li>
<li>PCでは選択肢からカーソルキー&amp;エンターキーでも選択できるようにする。</li>
</ul>
<p>この4つ目が肝です。</p>
<h2 id="対応方法">対応方法</h2>
<p>こちらに動くものを用意してあります。<br>
<a href="/demo/cursor-key-autocomplete/">デモ</a></p>
<p>HTMLは以下のようになっているとします。<br>
テキストボックスに文字を入力するとulタグ内に選択肢が表示されるようにします。</p>
<pre><code>&lt;input type=&quot;text&quot; id=&quot;keyword&quot; placeholder=&quot;都道府県名を入れてください&quot; autocomplete=&quot;off&quot;/&gt;
&lt;ul id=&quot;outputBox&quot;&gt;&lt;/ul&gt;
</code></pre><p>javascriptは以下の通りです。</p>
<pre><code>// 都道府県一覧
const prefectureList = ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県',
              '茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県',
              '新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県',
              '静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県',
              '奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県',
              '徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県',
              '熊本県','大分県','宮崎県','鹿児島県','沖縄県'];

// in/out要素を変数に入れておく
const inputElm = document.getElementById('keyword');
const outboxElm = document.getElementById('outputBox');

/**
 * テキストボックスに文字入力時
 */
inputElm.addEventListener('compositionend', function(e) {
    // タブキーは次の要素に移動させるのでスルー
    if (e.key == 'Tab') {
        return;
    }

    outboxElm.innerHTML = '';
    let _this = this;
    setTimeout(function(){
        // 入力された文字を含む都道府県を抽出する
        prefectureList.forEach(function(prefecture){
            if (prefecture.indexOf(_this.value) != -1) {
                let liElm = document.createElement('li');
                liElm.setAttribute('tabindex', '0');

                // 表示する選択肢にクリックイベントを設定する
                liElm.onclick = function() {
                    // 選択肢をクリックしたらテキストボックスに反映する
                    inputElm.value = this.innerHTML;
                    outboxElm.innerHTML = '';
                }

                // キーワードを含む選択肢をulに追加する
                let txtNode = document.createTextNode(prefecture);
                liElm.appendChild(txtNode);
                outboxElm.appendChild(liElm);
            }
        });
    }, 10);
});

/**
 * テキストボックスにフォーカスが当たっている時のキー操作
 */
inputElm.addEventListener('keydown', function(e) {
    // 下キーを入力されたら選択肢の一番上にフォーカスを当てる
    if (e.key == 'ArrowDown' || e.key == 'Down') {
        let firstElm = outboxElm.getElementsByTagName('li')[0];
        if (firstElm) {
            firstElm.focus();
        }
        e.preventDefault();
    }
});

/**
 * 選択肢にフォーカスが当たっている時のキー操作 or Enter
 */
outboxElm.addEventListener('keydown', function(e) {
    var currentElm = document.activeElement;

    // 下キーを入力されたら次の選択肢にフォーカスを当てる
    // ブラウザによりArrowDownだったりDownだったりする
    if (e.key == 'ArrowDown' || e.key == 'Down') {
        if (currentElm.nextElementSibling) {
            currentElm.nextElementSibling.focus();
        }
        e.preventDefault();
    }
    // 上キーを入力されたら前の選択肢にフォーカスを当てる
    // ブラウザによりArrowUpだったりUpだったりする
    if (e.key == 'ArrowUp' || e.key == 'Up') {
        if (currentElm.previousElementSibling) {
            currentElm.previousElementSibling.focus();
        }
        e.preventDefault();
    }
    // Enterを入力されたら現在の選択肢をクリックした時と同じ挙動をする
    if (e.key == 'Enter') {
        currentElm.click();
    }
});
</code></pre><p>これで基本的な挙動は実装できました。</p>
<p>なお、これだけではキーワードをBackspaceやDeleteで削除した際に選択肢を変更する処理は入っていません。<br>
必要であれば<code>keydown</code>イベント等を利用して文字削除時の処理を入れてください。</p>

	</div>

	<div class="pagination">
		<a href="/posts/2020/09/15/webpack-swiper-env-diff/" class="left arrow">&#8592;</a>
		<a href="/posts/2020/12/28/git-revert-revert/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-05-05 05:12:48.2679946 &#43;0900 JST m=&#43;0.087589101">2021</time> . Nonsense J
			</span>
		</footer>

    </body>
</html>
