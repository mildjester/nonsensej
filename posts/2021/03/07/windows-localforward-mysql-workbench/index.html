<!DOCTYPE html>
<html lang="ja-JP">
    <head>
		
		
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>WindowsのMySQL Workbenchで2段SSH踏み台で接続する &middot; Nonsense J</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Nonsense J" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Nonsense J</h2>
				</a>
				<ul>
    
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<h1 class="post-title">WindowsのMySQL Workbenchで2段SSH踏み台で接続する</h1>
		<div class="post-info">
				<time datetime="2021-03-07 00:00:00 &#43;0000 UTC">March 7, 2021</time>
			
				<div class="tags_list">
					 <div class="tags_item"><a href="/tags/windows/">Windows</a></div>
				</div>
			
		</div>
		<h2 id="環境">環境</h2>
<ul>
<li>Windows 10</li>
<li>MySQL Workbench 8.0</li>
<li>WSL2 (Ubuntu 20.04)</li>
</ul>
<hr>
<h2 id="やりたいこと">やりたいこと</h2>
<p>作業PCからDBに接続するまでに2段階のSSH接続を挟む環境があるとします。<br>
<!-- raw HTML omitted --></p>
<p>この環境で作業PC(Windows)からMySQL WorkbenchでDBに接続します。</p>
<p>基本的なSSH操作はWSL上でコマンドを打つ前提とします。<br>
Windows上でSSH操作をする場合は後述のSSHコンフィグのパスはWindows用に読み替えてください。<br>
(SSHコマンドや秘密鍵パスなど)</p>
<h2 id="駄目なパターン">駄目なパターン</h2>
<p>WSL上の<code>~/.ssh/config</code>に以下の記載をしていれば、アプリケーションサーバーへSSH接続はできます。</p>
<pre><code>Host fumidai-server
    HostName 111.111.111.111
    User my-user
    IdentityFile ~/.ssh/id_rsa_hoge
    IdentitiesOnly yes

Host app-server
    HostName 222.222.222.222
    User my-user
    ProxyCommand ssh -W %h:%p fumidai-server
    IdentityFile ~/.ssh/id_rsa_hoge
    ForwardAgent yes
</code></pre><p>※HostName, User, IdentityFileは適宜読み替えてください。</p>
<p>ここで指定しているProxyCommand設定により、<br>
<code>app-server</code>へSSHする時は<code>fumidai-server</code>を経由するようになります。</p>
<p>しかし、MySQL Workbenchの<code>TCP/IP over SSH</code>で<code>app-server</code>を指定して<br>
<code>fumidai-server</code> ⇒ <code>app-server</code> ⇒ DB<br>
という接続をしようとしても接続できません。<br>
(MacやUbuntu等であれば接続できる。なぜかWindowsだけ不可。)</p>
<h2 id="良いパターン">良いパターン</h2>
<p>MySQL Workbenchの<code>TCP/IP over SSH</code>は利用せずに、<br>
SSH Local ForwardでDBに繋がるようにしておいてからMySQL Workbenchを繋ぎます。</p>
<p>まず、<code>~/.ssh/config</code>は以下のようにします。</p>
<pre><code>Host fumidai-server
    HostName 111.111.111.111
    User my-user
    IdentityFile ~/.ssh/id_rsa_hoge
    IdentitiesOnly yes

Host app-server-localforward
    HostName 222.222.222.222
    User my-user
    ProxyCommand ssh -W %h:%p fumidai-server
    IdentityFile ~/.ssh/id_rsa_hoge
    GatewayPorts yes
    LocalForward 53306 hogehoge.ap-northeast-1.rds.amazonaws.com:3306
</code></pre><p>先ほどとの違いは<code>GatewayPorts</code>と<code>LocalForward</code>の設定が増えています。<br>
これで<code>app-server-localforward</code>へSSH接続すれば、ローカルの53306ポートが<br>
DBの3306ポートに繋がるようになります。<br>
※DBのホスト名は適宜読み替えてください。</p>
<p>MySQL Workbenchの接続設定は以下のようにします。<br>
SSHコンフィグファイルを読み込む必要はありません。</p>
<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>Connection Method</td>
<td>Standard（TCP/IP)</td>
</tr>
<tr>
<td>Hostname</td>
<td>127.0.0.1</td>
</tr>
<tr>
<td>Port</td>
<td>53306</td>
</tr>
<tr>
<td>Username</td>
<td>DBのユーザー</td>
</tr>
<tr>
<td>Password</td>
<td>DBのパスワード</td>
</tr>
</tbody>
</table>
<p>これで設定は完了です。</p>
<p>繋ぐ場合は以下の手順で繋ぎます。<br>
① SSHコマンドで<code>app-server-localforward</code>に繋いでおく。<br>
② MySQL WorkbenchでDBに接続する。</p>

	</div>

	<div class="pagination">
		<a href="/posts/2021/02/21/larave-observer-stop/" class="left arrow">&#8592;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			
			<span>
			&copy; <time datetime="2021-05-05 05:12:48.2712259 &#43;0900 JST m=&#43;0.090820401">2021</time> . Nonsense J
			</span>
		</footer>

    </body>
</html>
